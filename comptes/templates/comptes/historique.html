<!-- comptes/templates/comptes/historique.html (Version Finale Corrigée) -->
{% extends 'base.html' %}

{% block content %}
    <h1>Mon Historique des Commandes et Réservations</h1>

    <!-- Ce petit formulaire caché est essentiel pour que le JavaScript puisse trouver le CSRF token -->
    <form style="display:none;">{% csrf_token %}</form>

    {% if reservations %}
        <table class="table-historique">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Détails</th>
                    <th>Date / Heure</th>
                    <th>Prix Total</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for resa in reservations %}
                    <tr id="resa-row-{{ resa.id }}">
                        <td>{{ resa.get_type_reservation_display }}</td>
                        
                        <td>
                            {% if resa.type_reservation == 'SALLE' %}
                                {% if resa.salle %}<strong>{{ resa.salle.nom }}</strong>{% else %}<span style="color: red;">Salle Supprimée</span>{% endif %}
                            {% elif resa.type_reservation == 'GATEAU' %}
                                {% if resa.gateau_details %}
                                    <ul style="margin: 0; padding-left: 20px;">
                                        {% for item in resa.gateau_details %}
                                            <li>{{ item.quantite }} x {{ item.nom }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    Détails non disponibles
                                {% endif %}
                            {% endif %}
                        </td>
                        
                        <td>
                            {% if resa.type_reservation == 'SALLE' %}
                                {% if resa.date_reservation %}{{ resa.date_reservation|date:"d F Y" }}{% endif %}
                                {% if resa.heure_debut %}<br>à {{ resa.heure_debut|time:"H:i" }}{% endif %}
                            {% else %}
                                Commande directe
                            {% endif %}
                        </td>
                        
                        <td><strong>{{ resa.prix_total }} €</strong></td>
                        
                        <td>{{ resa.get_statut_display }}</td>
                        
                        <td>
                            <button class="btn-danger" onclick="supprimerReservation({{ resa.id }})">
                                Supprimer
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Vous n'avez encore passé aucune commande ou réservation.</p>
    {% endif %}

    <br>
    <a href="{% url 'liste_salles' %}"><button>Réserver une Salle</button></a>
    <a href="{% url 'liste_gateaux' %}"><button>Commander un Gâteau</button></a>


    <!-- ======================================== -->
    <!--     SCRIPT POUR LA SUPPRESSION           -->
    <!-- ======================================== -->
    <script>
    function supprimerReservation(reservationId) {
        if (!confirm("Êtes-vous sûr de vouloir supprimer cette ligne de votre historique ?")) {
            return; 
        }

        const url = `/comptes/historique/supprimer/${reservationId}/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value; 

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'succes') {
                const row = document.getElementById(`resa-row-${reservationId}`);
                if (row) {
                    row.style.transition = 'opacity 0.5s ease-out';
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 500);
                }
            } else {
                alert('Erreur: ' + data.message);
            }
        });
    }
    </script>

{% endblock %}